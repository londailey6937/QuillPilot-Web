<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supabase Connection Test</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        margin-bottom: 30px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border-left: 4px solid #ddd;
        background: #f9f9f9;
      }
      .test-section.success {
        border-left-color: #22c55e;
        background: #f0fdf4;
      }
      .test-section.error {
        border-left-color: #ef4444;
        background: #fef2f2;
      }
      .test-section.pending {
        border-left-color: #3b82f6;
        background: #eff6ff;
      }
      .status {
        font-weight: 600;
        margin-bottom: 10px;
      }
      .success .status {
        color: #22c55e;
      }
      .error .status {
        color: #ef4444;
      }
      .pending .status {
        color: #3b82f6;
      }
      .details {
        font-size: 14px;
        color: #666;
        margin: 10px 0;
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 20px;
      }
      button:hover {
        background: #2563eb;
      }
      button:disabled {
        background: #94a3b8;
        cursor: not-allowed;
      }
      .env-check {
        font-family: monospace;
        background: #f1f5f9;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 12px;
      }
      .tip {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 12px;
        margin: 15px 0;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Supabase Connection Verification</h1>

      <div id="test-results">
        <div class="test-section pending" id="env-check">
          <div class="status">‚è≥ Checking environment variables...</div>
          <div class="details" id="env-details"></div>
        </div>

        <div class="test-section pending" id="connection-check">
          <div class="status">‚è≥ Testing Supabase connection...</div>
          <div class="details" id="connection-details"></div>
        </div>

        <div class="test-section pending" id="auth-check">
          <div class="status">‚è≥ Testing authentication...</div>
          <div class="details" id="auth-details"></div>
        </div>

        <div class="test-section pending" id="database-check">
          <div class="status">‚è≥ Testing database schema...</div>
          <div class="details" id="database-details"></div>
        </div>
      </div>

      <button onclick="runTests()" id="test-button">Run Tests Again</button>

      <div class="tip" id="troubleshooting" style="display: none">
        <strong>üí° Troubleshooting:</strong>
        <ul id="tips-list"></ul>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

      let supabase;
      let hasErrors = false;

      function setStatus(elementId, status, message, details = "") {
        const element = document.getElementById(elementId);
        element.className = `test-section ${status}`;

        let icon = "‚è≥";
        if (status === "success") icon = "‚úÖ";
        if (status === "error") icon = "‚ùå";

        element.querySelector(".status").innerHTML = `${icon} ${message}`;
        element.querySelector(".details").innerHTML = details;
      }

      function addTip(tip) {
        const tipsList = document.getElementById("tips-list");
        const li = document.createElement("li");
        li.textContent = tip;
        tipsList.appendChild(li);
        document.getElementById("troubleshooting").style.display = "block";
      }

      async function runTests() {
        hasErrors = false;
        document.getElementById("test-button").disabled = true;
        document.getElementById("troubleshooting").style.display = "none";
        document.getElementById("tips-list").innerHTML = "";

        // Reset all sections
        [
          "env-check",
          "connection-check",
          "auth-check",
          "database-check",
        ].forEach((id) => {
          const element = document.getElementById(id);
          element.className = "test-section pending";
        });

        // Test 1: Environment Variables
        const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
        const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

        if (
          !supabaseUrl ||
          supabaseUrl === "" ||
          supabaseUrl === "your-project-url.supabase.co"
        ) {
          setStatus(
            "env-check",
            "error",
            "Environment variables not configured",
            `<div class="env-check">VITE_SUPABASE_URL: ${
              supabaseUrl || "NOT SET"
            }</div>
           <p>The Supabase URL is not properly configured.</p>`
          );
          hasErrors = true;
          addTip(
            "In Vercel: Go to Settings ‚Üí Environment Variables ‚Üí Add VITE_SUPABASE_URL"
          );
          addTip(
            "Get your URL from: Supabase Dashboard ‚Üí Settings ‚Üí API ‚Üí Project URL"
          );
        } else if (
          !supabaseKey ||
          supabaseKey === "" ||
          supabaseKey === "your-anon-key"
        ) {
          setStatus(
            "env-check",
            "error",
            "Anon key not configured",
            `<div class="env-check">VITE_SUPABASE_URL: ${supabaseUrl.substring(
              0,
              40
            )}...<br>
           VITE_SUPABASE_ANON_KEY: NOT SET</div>
           <p>The Supabase anon key is not configured.</p>`
          );
          hasErrors = true;
          addTip(
            "In Vercel: Go to Settings ‚Üí Environment Variables ‚Üí Add VITE_SUPABASE_ANON_KEY"
          );
          addTip(
            "Get your key from: Supabase Dashboard ‚Üí Settings ‚Üí API ‚Üí Project API keys ‚Üí anon public"
          );
        } else {
          setStatus(
            "env-check",
            "success",
            "Environment variables configured",
            `<div class="env-check">VITE_SUPABASE_URL: ${supabaseUrl}<br>
           VITE_SUPABASE_ANON_KEY: ${supabaseKey.substring(0, 40)}...</div>`
          );

          // Initialize Supabase client
          supabase = createClient(supabaseUrl, supabaseKey);

          // Test 2: Connection
          try {
            const { data, error } = await supabase
              .from("users")
              .select("count", { count: "exact", head: true });

            if (error) {
              if (
                error.message.includes("JWT") ||
                error.message.includes("Invalid API key")
              ) {
                setStatus(
                  "connection-check",
                  "error",
                  "Invalid API credentials",
                  `<p>Error: ${error.message}</p>
                 <p>Your anon key appears to be invalid or expired.</p>`
                );
                addTip(
                  "Verify your VITE_SUPABASE_ANON_KEY matches the key in Supabase Dashboard ‚Üí Settings ‚Üí API"
                );
                addTip(
                  'Make sure you copied the "anon public" key, not the service_role key'
                );
              } else if (
                error.message.includes("relation") ||
                error.message.includes("does not exist")
              ) {
                setStatus(
                  "connection-check",
                  "success",
                  "Connected to Supabase",
                  `<p>Successfully connected, but database schema needs setup.</p>`
                );
              } else {
                setStatus(
                  "connection-check",
                  "error",
                  "Connection failed",
                  `<p>Error: ${error.message}</p>`
                );
                addTip("Check if your Supabase project is active (not paused)");
              }
              hasErrors = true;
            } else {
              setStatus(
                "connection-check",
                "success",
                "Successfully connected to Supabase",
                `<p>Connection is working properly.</p>`
              );
            }
          } catch (err) {
            setStatus(
              "connection-check",
              "error",
              "Connection error",
              `<p>Error: ${err.message}</p>`
            );
            hasErrors = true;
            addTip("Check your network connection and Supabase project status");
          }

          // Test 3: Authentication
          try {
            const { data: sessionData, error: sessionError } =
              await supabase.auth.getSession();

            if (sessionError) {
              setStatus(
                "auth-check",
                "error",
                "Authentication system error",
                `<p>Error: ${sessionError.message}</p>`
              );
              hasErrors = true;
              addTip(
                "Check that authentication is enabled in Supabase Dashboard ‚Üí Authentication"
              );
            } else if (sessionData.session) {
              setStatus(
                "auth-check",
                "success",
                "User is signed in",
                `<p>Email: ${sessionData.session.user.email}</p>
               <p>Authentication is working.</p>`
              );
            } else {
              setStatus(
                "auth-check",
                "success",
                "Authentication ready",
                `<p>No user currently signed in (this is normal).</p>
               <p>Authentication system is properly configured.</p>`
              );
            }
          } catch (err) {
            setStatus(
              "auth-check",
              "error",
              "Authentication check failed",
              `<p>Error: ${err.message}</p>`
            );
            hasErrors = true;
          }

          // Test 4: Database Schema
          try {
            const { error: usersError } = await supabase
              .from("users")
              .select("id")
              .limit(1);
            const { error: analysesError } = await supabase
              .from("saved_analyses")
              .select("id")
              .limit(1);

            const usersExists =
              !usersError || !usersError.message.includes("does not exist");
            const analysesExists =
              !analysesError ||
              !analysesError.message.includes("does not exist");

            if (usersExists && analysesExists) {
              setStatus(
                "database-check",
                "success",
                "Database schema is set up",
                `<p>Both 'users' and 'saved_analyses' tables exist and are accessible.</p>
               <p>Your database is ready to use!</p>`
              );
            } else {
              const missing = [];
              if (!usersExists) missing.push("users");
              if (!analysesExists) missing.push("saved_analyses");

              setStatus(
                "database-check",
                "error",
                "Database schema incomplete",
                `<p>Missing tables: ${missing.join(", ")}</p>
               <p>You need to run the schema SQL to create these tables.</p>`
              );
              hasErrors = true;
              addTip("Go to Supabase Dashboard ‚Üí SQL Editor");
              addTip("Open supabase_schema.sql from your project");
              addTip(
                "Copy and paste the entire SQL into the editor and run it"
              );
            }
          } catch (err) {
            setStatus(
              "database-check",
              "error",
              "Database check failed",
              `<p>Error: ${err.message}</p>`
            );
            hasErrors = true;
          }
        }

        document.getElementById("test-button").disabled = false;

        // Summary
        if (!hasErrors) {
          setTimeout(() => {
            alert(
              "‚úÖ All tests passed! Your Supabase connection is working perfectly."
            );
          }, 500);
        }
      }

      // Make runTests available globally
      window.runTests = runTests;

      // Run tests on page load
      window.addEventListener("load", runTests);
    </script>
  </body>
</html>
